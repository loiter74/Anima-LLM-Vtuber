# Anima 项目 4+1 视图架构文档

## 项目概述

**Anima** 是一个可配置的 AI 虚拟伴侣/VTuber 框架，支持多种 LLM/ASR/TTS 服务商，具备流式响应、多模态交互能力。

---

## 1. 逻辑视图 (Logical View)

逻辑视图描述系统的核心抽象和功能需求，展示主要组件及其关系。

### 1.1 核心领域模型

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Anima 核心架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐    ┌──────────────────┐    ┌──────────────────┐          │
│  │   Client     │    │   Socket.IO      │    │   ServiceContext │          │
│  │  (Frontend)  │◄──►│    Server        │───►│   (服务容器)      │          │
│  └──────────────┘    └──────────────────┘    └────────┬─────────┘          │
│                                                        │                    │
│                              ┌─────────────────────────┼───────────────┐    │
│                              │                         │               │    │
│                              ▼                         ▼               ▼    │
│                    ┌──────────────┐          ┌──────────────┐  ┌──────────┐ │
│                    │  Pipeline    │          │   Services   │  │   EventBus│ │
│                    │  (处理管线)   │          │  (服务工厂)   │  │  (事件总线)│ │
│                    └──────┬───────┘          └──────┬───────┘  └─────┬────┘ │
│                           │                         │                │      │
│              ┌────────────┼────────────┐           │                │      │
│              │            │            │           │                │      │
│              ▼            ▼            ▼           ▼                ▼      │
│        ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   ┌───────────┐  │
│        │ASRStep  │  │LLMStep  │  │TTSHan..│  │Factory  │   │  Handlers │  │
│        └─────────┘  └─────────┘  └─────────┘  │ Pattern │   └───────────┘  │
│                                               └─────────┘                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心接口定义

```python
# 服务接口 (services/interface.py)
class ASRInterface:
    """语音识别接口"""
    async def transcribe(audio_data: np.ndarray) -> str

class TTSInterface:
    """语音合成接口"""
    async def synthesize(text: str) -> AsyncIterator[bytes]

class AgentInterface:
    """AI Agent 接口"""
    async def chat(text: str) -> AsyncIterator[str | dict]

class VADInterface:
    """语音活动检测接口"""
    def detect_speech(audio_chunk: list) -> Iterator[bytes]

# 管线接口 (pipeline/base.py)
class PipelineStep:
    """管线步骤抽象基类"""
    async def process(ctx: PipelineContext) -> None

# 事件总线接口 (eventbus/bus.py)
class EventBus:
    """事件总线"""
    def subscribe(event_type: str, handler: EventHandler)
    async def emit(event: OutputEvent)
```

### 1.3 核心数据结构

```python
# PipelineContext - 管线上下文
@dataclass
class PipelineContext:
    raw_input: Union[str, np.ndarray]  # 原始输入
    text: str                           # 处理后的文本
    response: str                       # AI 响应
    metadata: Dict[str, Any]           # 元数据
    error: Optional[str]               # 错误信息

# OutputEvent - 输出事件
@dataclass
class OutputEvent:
    type: str          # 事件类型
    data: Any          # 事件数据
    seq: int           # 序号
    metadata: Dict     # 元数据

# ConversationResult - 对话结果
@dataclass
class ConversationResult:
    full_response: str
    interrupted: bool
    heard_response: str
    error: Optional[str]
```

---

## 2. 过程视图 (Process View)

过程视图描述系统的运行时行为、数据流和并发处理。

### 2.1 主要对话流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           完整对话处理流程                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户输入                                                                    │
│     │                                                                       │
│     ├─── 文本输入 ──────────────────────────────────┐                       │
│     │                                               │                       │
│     └─── 语音输入 ──┐                               │                       │
│                      │                               │                       │
│                      ▼                               │                       │
│              ┌───────────────┐                       │                       │
│              │  VAD 检测     │                       │                       │
│              │  (语音活动)   │                       │                       │
│              └───────┬───────┘                       │                       │
│                      │                               │                       │
│                      ▼                               │                       │
│              ┌───────────────┐                       │                       │
│              │  ASR 转录     │                       │                       │
│              │  (语音→文本)  │                       │                       │
│              └───────┬───────┘                       │                       │
│                      │                               │                       │
│                      └───────────────┬───────────────┘                       │
│                                      │                                       │
│                                      ▼                                       │
│                              ┌───────────────┐                               │
│                              │  Text Clean   │                               │
│                              │  (文本清洗)   │                               │
│                              └───────┬───────┘                               │
│                                      │                                       │
│                                      ▼                                       │
│                              ┌───────────────┐                               │
│                              │  LLM Agent    │◄───── 流式响应               │
│                              │  (AI 生成)    │                               │
│                              └───────┬───────┘                               │
│                                      │                                       │
│                        ┌─────────────┼─────────────┐                         │
│                        │             │             │                         │
│                        ▼             ▼             ▼                         │
│                  ┌──────────┐ ┌──────────┐ ┌──────────┐                      │
│                  │ EventBus │ │   TTS    │ │ 工具调用 │                      │
│                  │  分发    │ │ (文本→语音)│ │ Handler │                      │
│                  └────┬─────┘ └────┬─────┘ └──────────┘                      │
│                       │            │                                       │
│                       ▼            ▼                                       │
│                  ┌──────────────────────┐                                   │
│                  │   WebSocket 推送     │                                   │
│                  │   (发送到前端)       │                                   │
│                  └──────────────────────┘                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 并发与异步处理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              运行时并发模型                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Main Event Loop (uvicorn + asyncio)                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐              │   │
│   │   │  Session 1  │   │  Session 2  │   │  Session N  │   独立会话   │   │
│   │   │             │   │             │   │             │              │   │
│   │   │ Orchestrator│   │ Orchestrator│   │ Orchestrator│              │   │
│   │   │ ServiceCtx  │   │ ServiceCtx  │   │ ServiceCtx  │              │   │
│   │   │ AudioBuffer │   │ AudioBuffer │   │ AudioBuffer │              │   │
│   │   └─────────────┘   └─────────────┘   └─────────────┘              │   │
│   │                                                                     │   │
│   │   Socket.IO 事件处理 (异步)                                         │   │
│   │   ┌─────────────────────────────────────────────────────────────┐  │   │
│   │   │  connect | disconnect | text_input | mic_audio_data | ...  │  │   │
│   │   └─────────────────────────────────────────────────────────────┘  │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   流式处理链:                                                               │
│   LLM Stream ──► TTS Stream ──► WebSocket Push                             │
│   (异步生成器)    (异步迭代器)    (异步发送)                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 事件流时序图

```
Frontend          Socket.IO Server      Orchestrator       Services
    │                   │                    │                 │
    │──── connect ─────►│                    │                 │
    │◄── connection ────│                    │                 │
    │    established    │                    │                 │
    │                   │                    │                 │
    │── text_input ────►│                    │                 │
    │                   │── process_input ──►│                 │
    │                   │                    │── chat ────────►│ LLM
    │                   │                    │◄─ stream chunk ─│
    │                   │                    │── synthesize ──►│ TTS
    │◄── sentence ──────│◄── event emit ─────│◄─ audio chunk ──│
    │◄── audio ─────────│◄── event emit ─────│                 │
    │                   │                    │                 │
    │── interrupt ─────►│                    │                 │
    │◄── interrupted ───│── interrupt ──────►│                 │
    │                   │                    │                 │
```

---

## 3. 开发视图 (Development View)

开发视图描述系统的代码组织、模块结构和构建依赖。

### 3.1 项目目录结构

```
Anima/
├── config/                          # 配置文件
│   ├── config.yaml                  # 主配置 (用户编辑)
│   ├── profiles/                    # 服务方案配置
│   │   ├── mock.yaml
│   │   ├── openai.yaml
│   │   ├── glm.yaml
│   │   └── ollama.yaml
│   └── personas/                    # 人设配置
│       ├── default.yaml
│       └── neuro-vtuber.yaml
│
├── src/anima/                       # 后端源代码
│   ├── __init__.py
│   ├── socketio_server.py           # 主入口 - Socket.IO 服务端
│   ├── service_context.py           # 服务上下文管理器
│   │
│   ├── core/                        # 核心抽象
│   │   ├── types.py                 # 核心类型定义
│   │   ├── context.py               # PipelineContext
│   │   └── events.py                # 事件类型定义
│   │
│   ├── config/                      # 配置系统
│   │   ├── app.py                   # AppConfig
│   │   ├── persona.py               # 人设配置
│   │   ├── core/                    # 配置核心
│   │   │   ├── base.py              # 基础配置类
│   │   │   └── registry.py          # 注册表 (装饰器模式)
│   │   └── providers/               # 服务商配置
│   │       ├── llm/                 # LLM 配置
│   │       ├── asr/                 # ASR 配置
│   │       ├── tts/                 # TTS 配置
│   │       └── vad/                 # VAD 配置
│   │
│   ├── services/                    # 服务实现
│   │   ├── llm/                     # LLM 服务
│   │   │   ├── interface.py         # 接口定义
│   │   │   ├── factory.py           # 工厂方法
│   │   │   └── implementations/     # 实现
│   │   │       ├── openai_agent.py
│   │   │       ├── glm_agent.py
│   │   │       ├── ollama_agent.py
│   │   │       └── mock_agent.py
│   │   ├── asr/                     # ASR 服务 (同结构)
│   │   ├── tts/                     # TTS 服务 (同结构)
│   │   └── vad/                     # VAD 服务 (同结构)
│   │
│   ├── pipeline/                    # 处理管线
│   │   ├── base.py                  # PipelineStep 基类
│   │   ├── input_pipeline.py        # 输入管线
│   │   ├── output_pipeline.py       # 输出管线
│   │   └── steps/                   # 管线步骤
│   │       ├── asr_step.py          # ASR 步骤
│   │       ├── llm_step.py          # LLM 步骤
│   │       └── text_clean_step.py   # 文本清洗步骤
│   │
│   ├── eventbus/                    # 事件总线
│   │   ├── bus.py                   # EventBus 实现
│   │   └── router.py                # 事件路由
│   │
│   ├── handlers/                    # 事件处理器
│   │   ├── base_handler.py          # Handler 基类
│   │   └── text_handler.py          # 文本处理器
│   │
│   └── state/                       # 状态管理
│       ├── audio_buffer.py          # 音频缓冲区
│       └── tts_task_manager.py      # TTS 任务管理
│
├── frontend/                        # 前端 (Next.js)
│   ├── app/                         # App Router
│   │   ├── layout.tsx               # 根布局
│   │   ├── page.tsx                 # 首页
│   │   └── globals.css              # 全局样式
│   ├── components/                  # React 组件
│   │   ├── ui/                      # shadcn/ui 组件
│   │   └── vtuber/                  # VTuber 相关组件
│   │       └── chat-panel.tsx       # 聊天面板
│   ├── hooks/                       # React Hooks
│   │   └── use-conversation.ts      # 对话 Hook
│   ├── lib/                         # 工具库
│   │   ├── socket.ts                # Socket.IO 客户端
│   │   └── utils.ts                 # 工具函数
│   └── package.json
│
├── scripts/                         # 脚本
│   ├── start.bat                    # Windows 启动脚本
│   ├── start.sh                     # Unix 启动脚本
│   └── test_*.py                    # 测试脚本
│
├── requirements.txt                 # Python 依赖
└── README.md
```

### 3.2 模块依赖关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              模块依赖图                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                          ┌──────────────────┐                               │
│                          │ socketio_server  │  (入口)                       │
│                          └────────┬─────────┘                               │
│                                   │                                         │
│              ┌────────────────────┼────────────────────┐                   │
│              │                    │                    │                   │
│              ▼                    ▼                    ▼                   │
│      ┌───────────────┐    ┌───────────────┐    ┌───────────────┐          │
│      │ ServiceContext│    │ Orchestrator  │    │    Config     │          │
│      └───────┬───────┘    └───────┬───────┘    └───────────────┘          │
│              │                    │                                         │
│              │            ┌───────┴───────┐                                │
│              │            │               │                                │
│              ▼            ▼               ▼                                │
│      ┌───────────────┐ ┌───────────┐ ┌───────────┐                         │
│      │   Services    │ │  Pipeline │ │  EventBus │                         │
│      │ (工厂模式)    │ │ (责任链)  │ │ (观察者)  │                         │
│      └───────┬───────┘ └─────┬─────┘ └─────┬─────┘                         │
│              │               │             │                               │
│              │               │             │                               │
│              └───────────────┴─────────────┘                               │
│                              │                                             │
│                              ▼                                             │
│                      ┌───────────────┐                                     │
│                      │     Core      │  (核心抽象)                         │
│                      │ - types       │                                     │
│                      │ - context     │                                     │
│                      │ - events      │                                     │
│                      └───────────────┘                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 设计模式应用

| 模式 | 应用位置 | 说明 |
|------|---------|------|
| **工厂模式** | `services/*/factory.py` | 根据配置创建服务实例 |
| **策略模式** | `services/*/implementations/` | 可替换的服务实现 |
| **责任链模式** | `pipeline/base.py` | Pipeline 步骤链式处理 |
| **观察者模式** | `eventbus/bus.py` | 事件发布/订阅 |
| **装饰器模式** | `config/core/registry.py` | 注册服务配置 |
| **单例模式** | `frontend/lib/socket.ts` | Socket 客户端 |

---

## 4. 物理视图 (Physical View)

物理视图描述系统的部署拓扑和硬件映射。

### 4.1 部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              部署架构                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         客户端层                                     │  │
│   │                                                                     │  │
│   │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐              │  │
│   │   │   Browser   │   │   Desktop   │   │   Mobile    │              │  │
│   │   │ (Next.js)   │   │   (Electron)│   │   (PWA)     │              │  │
│   │   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘              │  │
│   │          │                 │                 │                      │  │
│   │          └─────────────────┼─────────────────┘                      │  │
│   │                            │ WebSocket                              │  │
│   └────────────────────────────┼────────────────────────────────────────┘  │
│                                │                                           │
│                                ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         服务层                                       │  │
│   │                                                                     │  │
│   │   ┌───────────────────────────────────────────────────────────────┐ │  │
│   │   │              FastAPI + Socket.IO Server                       │ │  │
│   │   │              (Python + uvicorn)                               │ │  │
│   │   │                                                               │ │  │
│   │   │   Port: 12394 (可配置)                                        │ │  │
│   │   │   - WebSocket 连接管理                                        │ │  │
│   │   │   - 会话状态管理                                              │ │  │
│   │   │   - Pipeline 处理                                             │ │  │
│   │   └───────────────────────────────────────────────────────────────┘ │  │
│   │                            │                                        │  │
│   └────────────────────────────┼────────────────────────────────────────┘  │
│                                │                                           │
│                                ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        外部服务层                                    │  │
│   │                                                                     │  │
│   │   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐              │  │
│   │   │   OpenAI    │   │     GLM     │   │   Ollama    │              │  │
│   │   │  (Cloud)    │   │ (智谱 Cloud)│   │   (Local)   │              │  │
│   │   │             │   │             │   │             │              │  │
│   │   │ - GPT-4     │   │ - GLM-4     │   │ - Llama     │              │  │
│   │   │ - Whisper   │   │ - GLM ASR   │   │ - 本地模型   │              │  │
│   │   │ - TTS       │   │ - GLM TTS   │   │             │              │  │
│   │   └─────────────┘   └─────────────┘   └─────────────┘              │  │
│   │                                                                     │  │
│   │   ┌─────────────┐                                                   │  │
│   │   │  Edge TTS   │                                                   │  │
│   │   │  (Microsoft)│                                                   │  │
│   │   └─────────────┘                                                   │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 配置驱动多环境部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Profile 切换机制                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   config.yaml                                                               │
│   ┌─────────────────────────────────────┐                                  │
│   │ profile: "glm"                       │                                  │
│   │ persona: "neuro-vtuber"              │                                  │
│   └──────────────────┬──────────────────┘                                  │
│                      │                                                      │
│                      ▼                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         Profiles                                     │  │
│   │                                                                     │  │
│   │   mock.yaml          openai.yaml        glm.yaml        ollama.yaml │  │
│   │   ┌─────────┐       ┌─────────┐       ┌─────────┐     ┌─────────┐   │  │
│   │   │ ASR:    │       │ ASR:    │       │ ASR:    │     │ ASR:    │   │  │
│   │   │  mock   │       │ whisper │       │ glm-asr │     │  mock   │   │  │
│   │   │         │       │         │       │         │     │         │   │  │
│   │   │ TTS:    │       │ TTS:    │       │ TTS:    │     │ TTS:    │   │  │
│   │   │  mock   │       │ openai  │       │ glm-tts │     │  edge   │   │  │
│   │   │         │       │         │       │         │     │         │   │  │
│   │   │ LLM:    │       │ LLM:    │       │ LLM:    │     │ LLM:    │   │  │
│   │   │  mock   │       │ gpt-4   │       │ glm-4   │     │ ollama  │   │  │
│   │   └─────────┘       └─────────┘       └─────────┘     └─────────┘   │  │
│   │                                                                     │  │
│   │   用途: 测试         用途: 生产        用途: 国内      用途: 本地    │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 场景视图 (Scenarios / Use Cases)

场景视图描述系统的典型用例和关键业务场景。

### 5.1 核心用例图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用例图                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                          ┌──────────────────┐                               │
│                          │     Anima        │                               │
│                          │     System       │                               │
│                          └──────────────────┘                               │
│                                   │                                         │
│      ┌────────────────────────────┼────────────────────────────────────┐   │
│      │                            │                                    │   │
│      │    ┌───────────────────────┼───────────────────────┐           │   │
│      │    │                       │                       │           │   │
│      │    ▼                       ▼                       ▼           │   │
│      │ ┌────────┐           ┌────────┐            ┌────────┐          │   │
│      │ │语音对话│           │文本对话│            │配置管理│          │   │
│      │ └────────┘           └────────┘            └────────┘          │   │
│      │       │                   │                     │              │   │
│      │       │                   │                     │              │   │
│   ┌──┴───────┴───────────────────┴─────────────────────┴──┐           │   │
│   │                                                        │           │   │
│   │                      用户                              │           │   │
│   └────────────────────────────────────────────────────────┘           │   │
│                                                                         │   │
│   ┌────────────────────────────────────────────────────────┐           │   │
│   │                      管理员                             │           │   │
│   └────────────────────────┬───────────────────────────────┘           │   │
│                            │                                            │   │
│                            ▼                                            │   │
│                     ┌────────────┐                                     │   │
│                     │ 扩展服务   │                                     │   │
│                     │ (添加LLM)  │                                     │   │
│                     └────────────┘                                     │   │
│                                                                         │   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 核心场景详述

#### 场景 1: 语音对话

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    场景 1: 语音对话流程                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  前置条件: 用户已打开网页，WebSocket 已连接                                   │
│                                                                             │
│  1. 用户点击麦克风按钮，开始录音                                              │
│     └── Frontend: 发送 raw_audio_data 事件                                  │
│                                                                             │
│  2. VAD 检测语音活动                                                         │
│     ├── 检测到语音: 累积音频数据                                             │
│     └── 检测到静音: 触发 mic_audio_end                                       │
│                                                                             │
│  3. ASR 转录音频为文本                                                       │
│     └── 发送 user-transcript 到前端显示                                      │
│                                                                             │
│  4. LLM Agent 生成响应 (流式)                                                │
│     ├── 每个句子片段触发 sentence 事件                                       │
│     └── 前端实时显示 AI 回复                                                 │
│                                                                             │
│  5. TTS 合成语音 (流式)                                                      │
│     ├── 音频片段实时推送到前端                                                │
│     └── 前端播放音频                                                         │
│                                                                             │
│  6. 对话完成                                                                 │
│     └── 发送 conversation-end 控制信号                                       │
│                                                                             │
│  异常流程:                                                                   │
│  - 用户打断: 发送 interrupt_signal → 停止 TTS → 记录已听内容                  │
│  - ASR 失败: 发送 error 事件 → 提示用户重试                                  │
│  - 网络断开: 自动重连 → 恢复会话状态                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 场景 2: 文本对话

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    场景 2: 文本对话流程                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  前置条件: 用户已打开网页，WebSocket 已连接                                   │
│                                                                             │
│  1. 用户在输入框输入文本                                                      │
│     └── 点击发送 / 按 Enter                                                  │
│                                                                             │
│  2. Frontend 发送 text_input 事件                                            │
│     └── { text: "你好", metadata: {}, from_name: "User" }                   │
│                                                                             │
│  3. Orchestrator 处理输入                                                    │
│     ├── 跳过 ASR (已是文本)                                                  │
│     └── 直接调用 Agent                                                       │
│                                                                             │
│  4. LLM Agent 流式生成响应                                                   │
│     └── 通过 EventBus 分发 sentence 事件                                     │
│                                                                             │
│  5. TTS 合成 (可选)                                                          │
│     └── 根据配置决定是否启用语音                                              │
│                                                                             │
│  6. 前端显示响应                                                              │
│     ├── 文本实时显示在聊天界面                                                │
│     └── 音频自动播放                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 场景 3: 配置切换

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    场景 3: 配置热切换                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  触发条件: 用户需要切换服务商或人设                                            │
│                                                                             │
│  1. Frontend 发送 switch_config 事件                                         │
│     └── { file: "ollama" }                                                  │
│                                                                             │
│  2. Server 处理配置切换                                                      │
│     ├── 清理当前 Orchestrator                                                │
│     ├── 保留 ServiceContext (可选)                                          │
│     └── 加载新配置                                                           │
│                                                                             │
│  3. 重新初始化服务                                                            │
│     ├── ASR: openai → mock                                                  │
│     ├── TTS: openai → edge                                                  │
│     └── LLM: gpt-4 → ollama                                                 │
│                                                                             │
│  4. 发送确认                                                                  │
│     └── config-switched 事件                                                 │
│                                                                             │
│  5. 后续对话使用新配置                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 场景 4: 扩展新服务

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    场景 4: 开发者扩展新 LLM 服务                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  目标: 添加一个新的 LLM 服务商 (如 Claude)                                    │
│                                                                             │
│  步骤 1: 创建配置类                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ # src/anima/config/providers/llm/claude.py                          │   │
│  │                                                                     │   │
│  │ @ProviderRegistry.register_config("llm", "claude")                  │   │
│  │ class ClaudeConfig(LLMBaseConfig):                                  │   │
│  │     type: Literal["claude"] = "claude"                              │   │
│  │     api_key: str                                                    │   │
│  │     model: str = "claude-3-opus"                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  步骤 2: 创建服务实现                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ # src/anima/services/llm/implementations/claude_agent.py            │   │
│  │                                                                     │   │
│  │ @ProviderRegistry.register_service("llm", "claude")                 │   │
│  │ class ClaudeAgent(AgentInterface):                                  │   │
│  │     async def chat(self, text: str) -> AsyncIterator[str]:          │   │
│  │         # 调用 Claude API                                           │   │
│  │         ...                                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  步骤 3: 创建 Profile 配置                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ # config/profiles/claude.yaml                                       │   │
│  │ asr: { type: openai }                                               │   │
│  │ tts: { type: openai }                                               │   │
│  │ agent:                                                              │   │
│  │   llm_config:                                                       │   │
│  │     type: claude                                                    │   │
│  │     api_key: "${CLAUDE_API_KEY}"                                    │   │
│  │     model: "claude-3-opus"                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  步骤 4: 使用新配置                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ # config/config.yaml                                                │   │
│  │ profile: "claude"                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 架构总结

### 6.1 架构特点

| 特点 | 描述 |
|------|------|
| **插件化架构** | 通过装饰器注册服务，无需修改核心代码 |
| **Profile 驱动** | 通过切换配置文件更换服务商 |
| **流式处理** | LLM 和 TTS 支持流式响应，降低延迟 |
| **责任链模式** | Pipeline 步骤可灵活组合 |
| **事件驱动** | EventBus 解耦组件通信 |
| **会话隔离** | 每个客户端独立 ServiceContext |

### 6.2 技术栈

| 层次 | 技术 |
|------|------|
| 前端 | Next.js, React, TypeScript, Tailwind CSS, Socket.IO Client |
| 后端 | Python, FastAPI, Socket.IO, uvicorn |
| 通信 | WebSocket (Socket.IO) |
| AI 服务 | OpenAI API, 智谱 GLM, Ollama |
| 配置 | YAML, Pydantic |

### 6.3 关键设计决策

1. **选择 Socket.IO**: 支持WebSocket 回退、自动重连、房间管理
2. **工厂模式创建服务**: 解耦配置和实现
3. **Pipeline 责任链**: 灵活的数据处理流程
4. **EventBus 观察者**: 松耦合的事件分发
5. **Profile 配置分离**: 便于环境切换和部署

---

*文档生成时间: 2026-02-19*
*Anima Version: 1.0.0*