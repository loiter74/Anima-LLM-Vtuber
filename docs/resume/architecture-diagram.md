# 架构图示

> 用于面试和简历展示的架构图

---

## 目录

1. [系统架构图](#系统架构图)
2. [数据流图](#数据流图)
3. [组件关系图](#组件关系图)
4. [Live2D 情感系统图](#Live2D-情感系统图)
5. [扩展架构图](#扩展架构图)

---

## 系统架构图

### 五层架构

```
┌─────────────────────────────────────────────────────────────────┐
│                       Frontend Layer                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Next.js 16   │  │ React 19     │  │ Socket.IO    │         │
│  │ App Router   │  │ TypeScript   │  │ Client       │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Zustand      │  │ Live2D       │  │ Tailwind CSS │         │
│  │ State        │  │ pixi-live2d  │  │ shadcn/ui    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              ↕ WebSocket
┌─────────────────────────────────────────────────────────────────┐
│                    WebSocket Server                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Socket.IO    │  │ FastAPI      │  │ AsyncIO      │         │
│  │ Server       │  │ Framework    │  │ Event Loop   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  ConversationOrchestrator                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Input        │  │ Output       │  │ Event        │         │
│  │ Pipeline     │  │ Pipeline     │  │ Bus          │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      ServiceContext                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ LLM Service  │  │ ASR Service  │  │ TTS Service  │         │
│  │ (GLM/OpenAI) │  │ (Faster-Wh.) │  │ (Edge TTS)   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐                         │
│  │ VAD Service  │  │ Live2D       │                         │
│  │ (Silero)     │  │ System       │                         │
│  └──────────────┘  └──────────────┘                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Provider Registry                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Factory      │  │ Strategy     │  │ Observer     │         │
│  │ Pattern      │  │ Pattern      │  │ Pattern      │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

### 技术栈层次

```
┌─────────────────────────────────────────────────────────────────┐
│                        Frontend Stack                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Language: TypeScript                                      │  │
│  │ Framework: Next.js 16 (App Router)                        │  │
│  │ UI: React 19 + Tailwind CSS + shadcn/ui                  │  │
│  │ State: Zustand                                            │  │
│  │ Live2D: pixi-live2d-display                               │  │
│  │ Real-time: Socket.IO Client                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                         Backend Stack                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Language: Python 3.8+                                     │  │
│  │ Framework: FastAPI + AsyncIO                              │  │
│  │ Real-time: Socket.IO Server (python-socketio)             │  │
│  │ Validation: Pydantic                                      │  │
│  │ Logging: loguru                                           │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      External Services                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ LLM: GLM-4, OpenAI GPT-4, Ollama, Mock                   │  │
│  │ ASR: Faster-Whisper, GLM ASR, OpenAI Whisper, Mock       │  │
│  │ TTS: Edge TTS, GLM TTS, OpenAI TTS, Mock                 │  │
│  │ VAD: Silero VAD, Mock                                     │  │
│  │ Live2D: Hiyori, Haru, Epsilon                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 数据流图

### 对话流程

```
用户输入 (文本/音频)
        ↓
┌─────────────────────────────────────────────────────────────┐
│                   InputPipeline                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. ASRStep: 音频 → 文本 (Faster-Whisper)               │  │
│  │ 2. TextCleanStep: 文本清洗                              │  │
│  │ 3. EmotionExtractionStep: 情感提取                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│                  LLM Service (GLM-4)                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ chat_stream() → AsyncIterator[str | dict]              │  │
│  │ - 流式返回文本 Token                                      │  │
│  │ - 包含 [emotion] 标签                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│                  OutputPipeline                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. 累积 Tokens → 句子                                    │  │
│  │ 2. 发射 sentence 事件 (每个完整句子)                     │  │
│  │ 3. 触发 TTS 合成                                         │  │
│  │ 4. 发射 audio_with_expression 事件                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│                      EventBus                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ emit(OutputEvent) → 异步并发调用所有 Handler            │  │
│  │ - 异常隔离: 单个失败不影响其他                            │  │
│  │ - 优先级支持: HIGH > NORMAL > LOW                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│                      Handlers                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ TextHandler  │  │ AudioHandler │  │ Expression   │      │
│  │ (文本输出)   │  │ (音频输出)   │  │ Handler      │      │
│  └──────────────┘  └──────────────┘  │ (表情控制)   │      │
│                                     └──────────────┘      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ UnifiedEventHandler (统一音频+表情)                  │  │
│  │ - 音频数据 (base64)                                   │  │
│  │ - 音量包络 (50Hz)                                      │  │
│  │ - 情感时间轴                                          │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        ↓
    WebSocket → Frontend
```

### Live2D 表情流程

```
LLM 响应 (含 [emotion] 标签)
        ↓
┌─────────────────────────────────────────────────────────────┐
│            EmotionExtractionStep                             │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. 提取 [emotion] 标签 → EmotionTag[]                  │  │
│  │ 2. 验证情感有效性 (valid_emotions list)                 │  │
│  │ 3. 存储到 metadata["emotions"]                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│            EmotionAnalyzer (Plugin)                         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ LL MTagAnalyzer / KeywordAnalyzer                       │  │
│  │ - 分析情感标签 → EmotionData                            │  │
│  │ - primary: 主要情感                                      │  │
│  │ - confidence: 置信度                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│            TimelineStrategy (Plugin)                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ PositionBased / DurationBased / IntensityBased          │  │
│  │ - 计算情感时间轴 → TimelineSegment[]                    │  │
│  │ - emotion: 情感名称                                      │  │
│  │ - time: 开始时间                                        │  │
│  │ - duration: 持续时间                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│            UnifiedEventHandler                              │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. AudioAnalyzer: 计算音量包络 (50Hz)                   │  │
│  │ 2. 打包: audio + volumes + expressions                  │  │
│  │ 3. 发送: audio_with_expression 事件                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────────┐
│                  Frontend Live2D                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 1. AudioPlayer: 播放音频                                 │  │
│  │ 2. LipSyncEngine: 根据 volumes 控制嘴部 (~30fps)        │  │
│  │ 3. ExpressionTimeline: 根据 segments 控制表情            │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 组件关系图

### 设计模式应用

```
┌─────────────────────────────────────────────────────────────┐
│                    Factory Pattern                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ LLMFactory / ASRFactory / TTSFactory / VADFactory       │  │
│  │                                                          │  │
│  │ create_from_config(config) → Service Instance           │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                 Provider Registry Pattern                    │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ @ProviderRegistry.register_config("llm", "glm")          │  │
│  │ @ProviderRegistry.register_service("llm", "glm")         │  │
│  │                                                          │  │
│  │ 支持零修改扩展新服务                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                    Strategy Pattern                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ IEmotionAnalyzer (Interface)                             │  │
│  │   ├── LL MTagAnalyzer                                     │  │
│  │   └── KeywordAnalyzer                                    │  │
│  │                                                          │  │
│  │ ITimelineStrategy (Interface)                            │  │
│  │   ├── PositionBasedStrategy                              │  │
│  │   ├── DurationBasedStrategy                              │  │
│  │   └── IntensityBasedStrategy                             │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                    Observer Pattern                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ EventBus (Subject)                                       │  │
│  │   - subscribe(event_type, handler)                       │  │
│  │   - emit(event)                                          │  │
│  │                                                          │  │
│  │ Handlers (Observers)                                     │  │
│  │   ├── TextHandler                                        │  │
│  │   ├── AudioHandler                                       │  │
│  │   └── ExpressionHandler                                  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                    Pipeline Pattern                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ InputPipeline                                             │  │
│  │   data → Step1 → Step2 → Step3 → result                  │  │
│  │                                                          │  │
│  │ OutputPipeline                                            │  │
│  │   stream → accumulate → emit events                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                  Orchestrator Pattern                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ConversationOrchestrator                                 │  │
│  │   - 协调 InputPipeline, Agent, OutputPipeline            │  │
│  │   - 管理 EventBus 和 Handlers                            │  │
│  │   - 处理中断和错误                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## Live2D 情感系统图

### 插件化架构

```
┌─────────────────────────────────────────────────────────────┐
│              Live2D Emotion System                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ EmotionExtractionStep (Pipeline Step)                    │  │
│  │   - 从 LLM 响应提取 [emotion] 标签                      │  │
│  │   - 验证情感有效性                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ EmotionAnalyzer (Plugin - Strategy Pattern)             │  │
│  │   ┌────────────────────────────────────────────────────┐ │  │
│  │   │ LL MTagAnalyzer                                     │ │  │
│  │   │   - 分析 LLM 标签                                    │ │  │
│  │   │   - confidence_mode: first / frequency / majority   │ │  │
│  │   └────────────────────────────────────────────────────┘ │  │
│  │   ┌────────────────────────────────────────────────────┐ │  │
│  │   │ KeywordAnalyzer                                     │ │  │
│  │   │   - 关键词匹配 (80+ 关键词)                          │ │  │
│  │   │   - 6 种情感: happy, sad, angry, surprised, ...    │ │  │
│  │   └────────────────────────────────────────────────────┘ │  │
│  │   ↓ EmotionData { primary, confidence, emotions[] }     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ TimelineStrategy (Plugin - Strategy Pattern)            │  │
│  │   ┌────────────────────────────────────────────────────┐ │  │
│  │   │ PositionBasedStrategy                               │ │  │
│  │   │   - 基于位置分配时间                                 │ │  │
│  │   │   - 支持平滑过渡                                     │ │  │
│  │   └────────────────────────────────────────────────────┘ │  │
│  │   ┌────────────────────────────────────────────────────┐ │  │
│  │   │ DurationBasedStrategy                               │ │  │
│  │   │   - 基于权重分配时间                                 │ │  │
│  │   │   - 可配置 min_duration                              │ │  │
│  │   └────────────────────────────────────────────────────┘ │  │
│  │   ↓ TimelineSegment[] { emotion, time, duration }       │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ UnifiedEventHandler                                     │  │
│  │   ┌────────────────────────────────────────────────────┐ │  │
│  │   │ AudioAnalyzer                                       │ │  │
│  │   │   - 计算音量包络 (50Hz)                              │ │  │
│  │   │   - RMS 音量分析                                     │ │  │
│  │   └────────────────────────────────────────────────────┘ │  │
│  │   打包: audio + volumes + expressions                    │  │
│  │   发送: audio_with_expression 事件                       │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 前端 Live2D 集成

```
┌─────────────────────────────────────────────────────────────┐
│                  Frontend Live2D                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ useLive2D Hook                                           │  │
│  │   - 管理 Live2DService 生命周期                          │  │
│  │   - 提供 setExpression(), playAudioWithExpressions()     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Live2DService                                           │  │
│  │   ┌────────────────────────────────────────────────────┐ │  │
│  │   │ loadModel()                                         │ │  │
│  │   │   - 使用 pixi-live2d-display 加载模型               │ │  │
│  │   │   - 动态导入避免 SSR 问题                            │ │  │
│  │   └────────────────────────────────────────────────────┘ │  │
│  │   ┌────────────────────────────────────────────────────┐ │  │
│  │   │ setExpression(emotion)                              │ │  │
│  │   │   - 设置 Live2D 表情                                 │ │  │
│  │   │   - 支持多种情感类型                                 │ │  │
│  │   └────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ LipSyncEngine                                           │  │
│  │   - 根据 volumes 控制嘴部参数                            │  │
│  │   - ~30fps 更新频率                                      │  │
│  │   - EMA 平滑处理                                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ExpressionTimeline                                      │  │
│  │   - 播放情感时间轴                                       │  │
│  │   - requestAnimationFrame 同步                           │  │
│  │   - 自动切换表情                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Live2DViewer Component                                  │  │
│  │   - 渲染 Live2D 模型到 Canvas                            │  │
│  │   - 响应式布局                                           │  │
│  │   - 支持窗口缩放                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 扩展架构图

### 零修改扩展示例

```
┌─────────────────────────────────────────────────────────────┐
│            Provider Registry Pattern                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 已注册服务 (开箱即用)                                     │  │
│  │                                                          │  │
│  │ LLM: glm, openai, ollama, mock                           │  │
│  │ ASR: faster_whisper, glm, openai, mock                   │  │
│  │ TTS: edge, glm, openai, mock                             │  │
│  │ VAD: silero, mock                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 添加新服务 (3 步，零修改)                                 │  │
│  │                                                          │  │
│  │ 1. 定义配置类                                            │  │
│  │    @ProviderRegistry.register_config("llm", "deepseek")  │  │
│  │    class DeepSeekConfig(BaseModel): ...                  │  │
│  │                                                          │  │
│  │ 2. 实现服务类                                            │  │
│  │    @ProviderRegistry.register_service("llm", "deepseek") │  │
│  │    class DeepSeekAgent(LLMInterface): ...                │  │
│  │                                                          │  │
│  │ 3. 创建 YAML 配置                                        │  │
│  │    config/services/agent/deepseek.yaml                   │  │
│  │                                                          │  │
│  │ ✅ 新服务立即可用，无需修改现有代码                        │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│            Live2D Plugin Architecture                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 情感分析器 (可扩展)                                        │  │
│  │                                                          │  │
│  │ llm_tag_analyzer (LLM 标签分析)                          │  │
│  │ keyword_analyzer (关键词匹配, 80+ 关键词)                 │  │
│  │ ┌────────────────────────────────────────────────────┐  │  │
│  │ │ custom_analyzer (自定义, ~100 行代码)               │  │  │
│  │ │   - 实现 IEmotionAnalyzer 接口                       │  │  │
│  │ │   - 注册到 Factory                                   │  │  │
│  │ │   - YAML 配置启用                                     │  │  │
│  │ └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
│                           ↓                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 时间轴策略 (可扩展)                                        │  │
│  │                                                          │  │
│  │ position_based (基于位置)                                │  │
│  │ duration_based (基于时长权重)                            │  │
│  │ intensity_based (基于强度)                               │  │
│  │ ┌────────────────────────────────────────────────────┐  │  │
│  │ │ custom_strategy (自定义, ~100 行代码)               │  │  │
│  │ │   - 实现 ITimelineStrategy 接口                      │  │  │
│  │ │   - 注册到 Factory                                   │  │  │
│  │ │   - YAML 配置启用                                     │  │  │
│  │ └────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## 总结

### 架构图使用场景

1. **面试展示**: 使用系统架构图说明整体设计
2. **技术讨论**: 使用数据流图说明交互过程
3. **简历配图**: 使用设计模式图展示架构能力
4. **文档说明**: 使用 Live2D 系统图说明核心功能

### 面试要点

- **五层架构**: Frontend → WebSocket → Orchestrator → ServiceContext → Registry
- **设计模式**: Factory, Strategy, Observer, Pipeline, Orchestrator, Provider Registry
- **数据流**: InputPipeline → LLM → OutputPipeline → EventBus → Handlers
- **扩展性**: 零修改扩展，插件化设计

---

**最后更新**: 2026-02-28
