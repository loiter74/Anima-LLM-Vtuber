# Live2D å”‡åŒæ­¥é—®é¢˜è¯Šæ–­å’Œä¿®å¤

## é—®é¢˜æ€»ç»“

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š
1. **å”‡åŒæ­¥ä¸å¯è§** - åç«¯æ—¥å¿—æ˜¾ç¤ºå‚æ•°åœ¨æ›´æ–°ï¼Œä½†å‰ç«¯æ¨¡å‹å˜´éƒ¨ä¸åŠ¨
2. **æ¨¡å‹åœ¨éŸ³é¢‘æ’­æ”¾æ—¶æ¶ˆå¤±** - éŸ³é¢‘å¼€å§‹æ’­æ”¾æ—¶ï¼ŒLive2D æ¨¡å‹ä»å±å¹•ä¸Šæ¶ˆå¤±

## è¯Šæ–­å‘ç°

### 1. æ¨¡å‹å®šä½é”™è¯¯ï¼ˆå·²ä¿®å¤ï¼‰

**é—®é¢˜**ï¼šæ¨¡å‹ä½ç½®è®¡ç®—é”™è¯¯ï¼Œå¯¼è‡´æ¨¡å‹ä½äºå¯è§åŒºåŸŸä¹‹å¤–ã€‚

**é”™è¯¯ä»£ç **ï¼ˆ`Live2DService.ts` ç¬¬ 187-191 è¡Œï¼‰ï¼š
```typescript
const centerY = containerHeight / 2  // = 363 (å‡è®¾å®¹å™¨é«˜åº¦ 726)
const yOffset = containerHeight * (this.positionConfig.yOffsetPercent / 100)  // = 363 (50%)
this.model.y = centerY + yOffset  // = 726 (ç”»å¸ƒåº•éƒ¨è¾¹ç¼˜ï¼)
```

**å½±å“**ï¼š
- å½“ `yOffsetPercent: 50` æ—¶ï¼Œæ¨¡å‹çš„**ä¸­å¿ƒç‚¹**ä½äº y=726ï¼ˆç”»å¸ƒåº•éƒ¨è¾¹ç¼˜ï¼‰
- ç”±äºæ¨¡å‹çš„é”šç‚¹è®¾ç½®ä¸º `(0.5, 0.5)`ï¼ˆä¸­å¿ƒï¼‰ï¼Œæ¨¡å‹å®é™…ä¸Šä½äºå¯è§åŒºåŸŸä¹‹å¤–
- è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆæ¨¡å‹"æ¶ˆå¤±"äº†

**ä¿®å¤**ï¼š
```typescript
// ä¿®å¤ï¼šoffsetPercent åº”è¯¥ç›¸å¯¹äºåŠé«˜è®¡ç®—
const yOffset = (containerHeight / 2) * (this.positionConfig.yOffsetPercent / 100)
```

**ä¿®å¤åçš„ä½ç½®**ï¼š
- `yOffsetPercent: 50` â†’ yOffset = 183 â†’ model.y = 363 + 183 = 546
- è¿™å°†æ¨¡å‹ä¸­å¿ƒæ”¾åœ¨ç”»å¸ƒä¸­é—´åä¸‹çš„ä½ç½®ï¼Œæ›´åˆç†

### 2. é…ç½®æ–‡ä»¶æ›´æ–°

**æ›´æ”¹**ï¼š`frontend/public/config/live2d.json`
- æ¨¡å‹ä» Haru åˆ‡æ¢åˆ° Hiyori
- Hiyori æ¨¡å‹æœ‰ `ParamMouthOpenY`ï¼ˆç´¢å¼• 19ï¼‰å’Œ `ParamMouthForm`ï¼ˆç´¢å¼• 18ï¼‰
- Haru æ¨¡å‹æ²¡æœ‰å˜´éƒ¨å‚æ•°

### 3. è¡¨æƒ…æ—¶é—´è½´ä¸´æ—¶ç¦ç”¨

ä¸ºäº†è°ƒè¯•ï¼Œè¡¨æƒ…æ—¶é—´è½´å·²è¢«ä¸´æ—¶ç¦ç”¨ï¼ˆ`useLive2D.ts` ç¬¬ 308 è¡Œï¼‰ï¼š
```typescript
// TODO: ä¸´æ—¶ç¦ç”¨è¡¨æƒ…æ—¶é—´è½´ï¼Œè°ƒè¯•æ¨¡å‹æ¶ˆå¤±é—®é¢˜
// serviceRef.current.playTimeline(segments, totalDuration)
```

## ä½¿ç”¨è¯Šæ–­è„šæœ¬

### è„šæœ¬ 1: WebGL ä¸Šä¸‹æ–‡ + æ¨¡å‹ä½ç½®è¯Šæ–­

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// Copy the contents of:
// frontend/scripts/diagnose-webgl-and-position.js
```

æ­¤è„šæœ¬ä¼šæ£€æŸ¥ï¼š
- WebGL ä¸Šä¸‹æ–‡çŠ¶æ€ï¼ˆæ˜¯å¦ä¸¢å¤±ï¼‰
- æ¨¡å‹è¾¹ç•Œæ¡†ï¼ˆgetBoundsï¼‰
- æ¨¡å‹å½“å‰ä½ç½®
- æ¨¡å‹æ˜¯å¦åœ¨å¯è§åŒºåŸŸå†…
- æ¨èçš„æ¨¡å‹ä½ç½®

### è„šæœ¬ 2: éŸ³é¢‘æ’­æ”¾ç›‘æ§

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼ˆ**å…ˆè¿è¡Œæ­¤è„šæœ¬ï¼Œå†è§¦å‘éŸ³é¢‘æ’­æ”¾**ï¼‰ï¼š
```javascript
// Copy the contents of:
// frontend/scripts/monitor-audio-playback.js
```

æ­¤è„šæœ¬ä¼šï¼š
- æ¯ 100ms è½®è¯¢æ£€æŸ¥æ¨¡å‹çŠ¶æ€
- è®°å½•æ‰€æœ‰å±æ€§å˜åŒ–ï¼ˆx, y, alpha, visible, renderableï¼‰
- æ£€æµ‹æ¨¡å‹æ˜¯å¦ç§»å‡ºå¯è§åŒºåŸŸ
- æ˜¾ç¤ºè°ƒç”¨æ ˆï¼ˆå¦‚æœæ¨¡å‹è¢«è®¾ç½®ä¸ºä¸å¯è§ï¼‰
- 30 ç§’åè‡ªåŠ¨åœæ­¢ï¼Œæˆ–è°ƒç”¨ `__stopLive2DMonitor()` æ‰‹åŠ¨åœæ­¢

## æµ‹è¯•æ­¥éª¤

1. **é‡æ–°å¯åŠ¨å‰ç«¯**ï¼ˆåº”ç”¨å®šä½ä¿®å¤ï¼‰ï¼š
   ```bash
   cd frontend
   pnpm dev
   ```

2. **è¿è¡Œç›‘æ§è„šæœ¬**ï¼š
   - æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
   - å¤åˆ¶å¹¶ç²˜è´´ `monitor-audio-playback.js` çš„å†…å®¹
   - ç­‰å¾…"ç›‘æ§å·²å¯åŠ¨"æ¶ˆæ¯

3. **è§¦å‘éŸ³é¢‘æ’­æ”¾**ï¼š
   - åœ¨èŠå¤©ç•Œé¢å‘é€ä¸€æ¡æ¶ˆæ¯
   - è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º

4. **æ£€æŸ¥ç»“æœ**ï¼š
   - å¦‚æœçœ‹åˆ°"æ¨¡å‹å±æ€§å˜åŒ–"è­¦å‘Šï¼Œè®°å½•å˜åŒ–çš„å±æ€§
   - å¦‚æœçœ‹åˆ°"ğŸš¨ æ¨¡å‹åœ¨å¯è§åŒºåŸŸä¹‹å¤–"ï¼Œè¯´æ˜å®šä½ä»æœ‰é—®é¢˜
   - å¦‚æœçœ‹åˆ°"Y åæ ‡è¶…å‡ºç”»å¸ƒ"ï¼Œè¯´æ˜æ¨¡å‹è¢«ç§»åŠ¨åˆ°äº†é”™è¯¯ä½ç½®

5. **æ‰‹åŠ¨æµ‹è¯•å”‡åŒæ­¥**ï¼š
   ```javascript
   // åœ¨æ§åˆ¶å°æ‰‹åŠ¨æµ‹è¯•å˜´éƒ¨å‚æ•°
   const canvas = document.querySelector('canvas')
   const app = canvas.__pixiApp
   const model = app.stage.children.find(c => c.internalModel)

   // åº”è¯¥èƒ½çœ‹åˆ°å˜´éƒ¨å¼ å¼€
   model.internalModel.coreModel.setParameterValueByIndex(19, 1.0)
   model.internalModel.coreModel.update()
   ```

## é¢„æœŸç»“æœ

### ä¿®å¤ååº”è¯¥çœ‹åˆ°ï¼š
- âœ… æ¨¡å‹åœ¨éŸ³é¢‘æ’­æ”¾æœŸé—´ä¿æŒå¯è§
- âœ… å˜´éƒ¨å‚æ•°æ›´æ–°æ—¶ï¼Œå˜´éƒ¨ä¼šåŠ¨
- âœ… æ¨¡å‹ä½ç½®åœ¨å¯è§åŒºåŸŸå†…ï¼ˆä¸ä¼šåœ¨ç”»å¸ƒè¾¹ç¼˜ä¹‹å¤–ï¼‰

### å¦‚æœä»ç„¶æœ‰é—®é¢˜ï¼š
- è¿è¡Œè¯Šæ–­è„šæœ¬å¹¶åˆ†äº«è¾“å‡º
- æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯æ¶ˆæ¯
- ç¡®è®¤ä½¿ç”¨çš„æ˜¯ Hiyori æ¨¡å‹ï¼ˆä¸æ˜¯ Haruï¼‰

## å¾…è§£å†³çš„é—®é¢˜

1. **å”‡åŒæ­¥çµæ•åº¦** - å¦‚æœå˜´éƒ¨åŠ¨ä½œä¸å¤Ÿæ˜æ˜¾ï¼Œè°ƒæ•´é…ç½®ï¼š
   ```json
   // frontend/public/config/live2d.json
   "lipSync": {
     "sensitivity": 2.0,  // å¢åŠ çµæ•åº¦ï¼ˆå½“å‰å€¼ï¼‰
     "smoothing": 0.3,    // é™ä½å¹³æ»‘ï¼ˆååº”æ›´å¿«ï¼‰
     "minThreshold": 0.02 // é™ä½é˜ˆå€¼ï¼ˆæ›´å®¹æ˜“è§¦å‘ï¼‰
   }
   ```

2. **è¡¨æƒ…æ—¶é—´è½´** - ä¸€æ—¦æ¨¡å‹æ¶ˆå¤±é—®é¢˜è§£å†³ï¼Œé‡æ–°å¯ç”¨è¡¨æƒ…æ—¶é—´è½´ï¼š
   ```typescript
   // useLive2D.ts ç¬¬ 308 è¡Œ
   serviceRef.current.playTimeline(segments, totalDuration)
   ```

## ç›¸å…³æ–‡ä»¶

- `frontend/features/live2d/services/Live2DService.ts` - Live2D æœåŠ¡ï¼ˆå·²ä¿®å¤å®šä½ï¼‰
- `frontend/features/live2d/hooks/useLive2D.ts` - React Hookï¼ˆä¸´æ—¶ç¦ç”¨è¡¨æƒ…æ—¶é—´è½´ï¼‰
- `frontend/public/config/live2d.json` - Live2D é…ç½®ï¼ˆåˆ‡æ¢åˆ° Hiyoriï¼‰
- `frontend/scripts/diagnose-webgl-and-position.js` - WebGL è¯Šæ–­è„šæœ¬
- `frontend/scripts/monitor-audio-playback.js` - éŸ³é¢‘æ’­æ”¾ç›‘æ§è„šæœ¬

## ä¸‹ä¸€æ­¥

1. æµ‹è¯•ä¿®å¤åçš„ä»£ç 
2. å¦‚æœæ¨¡å‹ä»ç„¶æ¶ˆå¤±ï¼Œè¿è¡Œç›‘æ§è„šæœ¬å¹¶åˆ†äº«è¾“å‡º
3. å¦‚æœå”‡åŒæ­¥ä¸å¯è§ï¼Œè°ƒæ•´ `lipSync` é…ç½®å‚æ•°
4. ä¸€æ—¦ç¨³å®šï¼Œé‡æ–°å¯ç”¨è¡¨æƒ…æ—¶é—´è½´
